# 双因素认证（2FA）教程

https://techblog.bozho.net/enabling-two-factor-authentication-web-application/

认证（authentication）就是确认用户的身份，是网站登录必不可少的步骤。

密码登录是最常见的认证方法，但是很不安全，容易泄露和冒充。越来越多的网络服务，建议或强制用户开启双因素认证。

本文介绍双因素认证的概念和实现方法。

##  一、认证因素

一般来说，证明身份可以使用三种不同类型的证据。

> - **秘密信息**：只有用户知道、其他人不知道的某种信息，比如密码。
> - **个人物品**：用户的私人物品，比如现实生活中的钥匙。 
> - **生理特征**：用户的遗传特征，比如指纹、相貌、虹膜等等。

这三类证据就称为三类“因素”（factor），其中的任何一种，都可以证明用户的身份。很显然，证据的“因素”越多，用户的身份就越可靠。

双因素认证（Two-factor authentication，简称 2FA）就是指，通过认证至少需要两个因素。日常生活中，最常见的双因素认证就是，用户使用银行卡到 ATM 提现。用户必须同时提供银行卡（个人物品）和密码（秘密信息），才能取到现金。

## 二、常见的双因素认证

任何两类因素的组合，都属于双因素认证。互联网上，最常用的组合是密码 + 某种个人物品。比如，开办网上银行时，银行常常会提供一个 U 盾。用户必须插上 U 盾，再输入密码，才能登录网上银行。

可是，用户不可能随时随地携带 U 盾。于是，手机就成了最好的证明身份的个人物品。互联网上最常用的双因素组合，就是密码 + 手机。

国内的很多网站（尤其是金融类）往往要求，用户不仅输入密码，还要输入一条通过短消息发送的验证码，以证明用户确实拥有该手机号码。但是，短消息是很不安全的，因为不加密，容易被拦截和伪造。此外，SIM 卡可以被克隆，国内已经有案例通过伪造的身份证，重新申请了一模一样的手机号码，再从手机上把钱转走。

因此，更安全的双因素认证，不是密码 + 短消息，而是下面要介绍的密码 + 手机端 [TOTP](https://en.wikipedia.org/wiki/Time-based_One-time_Password_Algorithm) 密码。

## 三、双因素认证的优缺点

双因素认证的优点在于，比单纯的密码登录安全得多。就算密码泄露，只要手机还在，账户就是安全的。各种密码破解方法，都对双因素认证无效。

双因素认证的缺点在于，登录多了一道步骤，变得更费时和麻烦，用户会感到不耐烦。而且，它也不意味着账户的绝对安全，入侵者依然可以通过盗取 cookie 或 token，冒充用户。

双因素认证还有一个最大的问题，那就是帐户的恢复。一旦忘记密码或者遗失手机，想要恢复登录，势必就要绕过双因素认证，这就形成了一个安全漏洞。除非准备两套双因素认证，一套用来登录，另一套用来恢复账户。

## 四、TOTP

TOTP 的全称是基于时间的一次性密码（Time-based One-time Password），它是目前公认较为安全的双因素认证解决方案，已经写入了国际标准（[RFC6238](https://tools.ietf.org/html/rfc6238)），现实生活中非常常见。

它的原理是，通过一个与用户设备绑定的密钥，每隔一段时间（一般是30秒）就生成一个一次性密码。这个密码只在这30秒内有效，可以证明用户的身份。

TOTP 有硬件生成器和软件生成器之分，原理都是一样的。

