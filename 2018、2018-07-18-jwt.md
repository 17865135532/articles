# JSON Web Token 教程

## 跨域认证的问题

HTTP 是一个无状态协议，为了认证用户身份，通常需要在服务器保存 session 数据，在客户端通过 Cookie 保存一个 session_id。

随着服务导向的架构的流行，跨域认证越来越成为一个重要的问题。认证服务器与服务端可能不在同一个域，如何把 session 信息跨域传递？

JWT 提供了一个无状态的认证解决方案，它把 session 数据不保存在服务器，而是放在客户端。每次通信的时候，把这些数据带上就可以了。


## JWT 的特点

JWT 可以加密，但是默认是不加密，只对数据进行签名，防止数据被篡改。

JWT 可以用于认证，也可以用于交换信息，这样可以减少数据查询。

如果使用 HTTPS 协议传输，也不用担心泄密。

JWT 的主要问题是，它可能被盗用。由于 JWT 的主要场合是，服务器不保存状态，因此很难终止，或者中途改变权限。解决方案是缩短 JWT 的有效时限，对于一些重要的权限，需要再次要求用户输入密码。

## 数据结构

JWT 大概就像下面这样。

![](https://cdn.auth0.com/content/jwt/encoded-jwt3.png)

它是一个很长的字符串，中间用点分成三个部分。注意，JWT 内部是没有换行的，这里只是为了便于展示，将它分拆成了几行。

JWT 分成三个部分。

- Header
- Payload
- Signature

它的完整结构如下。

```javascript
Header.Payload.Signature
```

Header 部分通常是下面的样子。

```javascript
{
  "alg": "HS256",
  "typ": "JWT"
}
```

Payload 是数据体部分。它有以下属性。

-  iss (issuer)
- exp (expiration time)
- sub (subject)
- aud (audience)
- nbf (Not Before)
- iat (Issued At)
- jti (JWT ID)

你可以把私有字段放在这个部分。

```javascript
{
  "sub": "1234567890",
  "name": "John Doe",
  "admin": true
}
```

如果不加密，这部分可以被任何人读到，所以不要把秘密信息放在这个部分。

Signature 部分是对前两部分的签名。你需要指定一个密钥，然后使用加密算法（默认是 HMAC SHA256），按照下面的公式产生签名。

```javascript
HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  secret)
```

然后，把 BASE64 编码后的前两个部分与后面的签名拼接起来，每个部分之间用“点”（`.`）分隔。下面是一个例子。



## 使用方式

每次发到服务器的请求，都要带上 JWT。可以放在 Cookie 里面可以自动发送。

如果要跨域发送，这时不会带上 Cookie，就可以放在`Authorization`的头信息里面。

```javascript
Authorization: Bearer <token>
```

## 参考链接

- [Introduction to JSON Web Tokens](https://jwt.io/introduction/)， by Auth0
- [Sessionless Authentication using JWTs (with Node + Express + Passport JS)](https://medium.com/@bryanmanuele/sessionless-authentication-withe-jwts-with-node-express-passport-js-69b059e4b22c), by Bryan Manuele

（完）