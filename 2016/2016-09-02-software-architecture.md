# 软件架构入门

软件架构（software architecture）是软件的基本结构。对于大中型软件，合理的架构是成功的最重要要素；即使对于小软件，好的架构也有助除错和维护、扩展、升级。

了解各种不同的架构，也有助理解现有的软件，提高自己的编程水平。大软件公司会有专门的架构师职位（architect），只有资深程序员才可以担任。

 本文介绍五种最常见的软件架构。

## 层级架构

层级架构（layered architecture）是最常见的架构，也是事实上的标准架构。如果你不知道要用什么架构，那就用它。

这种架构的软件，分成若干个水平层，每一层都有自己的角色。层与层之间通过接口通信，不需要知道其他层的细节。这种设计可以做到职责清晰，容易开发和测试。

四层的结构最常见。

- presentation：负责用户界面，以及与用户互动
- business：业务逻辑
- persistence：提供数据，包括SQL语句
- database ：数据保存 

有的软件还会在逻辑层和持久层之间，增加一个服务层（service layer），用来提供不同业务逻辑需要的一些通用接口。

 用户的请求将依次通过这四层的处理，不能跳过其中任何一层。

- 架构简单，容易理解，因此也容易开发
- 层的职责分工，也方便不同技能的程序员分工，负责不同的层。天然适合大多数软件公司的组织架构。
- 测试容易。每一层都可以独立测试，其他层可以Mock。
- 适应性低：调整软件功能适应环境变化，通常比较麻烦和费时。
- 部署较麻烦，修改了一个组件，通常需要整个软件重新部署，不容易做持续构建。
- 软件升级也很麻烦，可能需要服务暂停
- 扩展性差。当用户请求大量增加时，必须依次扩展每一层，由于每一层内部是耦合的，通常会很困难。

## 事件驱动架构

 事件是状态发出变化时，软件发出的通知。分布式的异步架构，扩展性高。处理单元解耦，适合异步的分布式项目。事件处理组件高度解耦。

分成四个部分

- event queue 事件队列
- event mediator：分发器：不知道业务逻辑，但是知道如何处理事件
- event channel
- event processor 业务逻辑

 简单的项目：event queue event mediator，event channel，合成一体了。

优点

- 扩展性好，
- 适用各类项目
- 性能较好：因为异步本质，不易产生堵塞
- 容易部署

缺点

- 开发相对复杂：异步问题：失去响应，远程通信
- 难以支持原子性操作：有的事件涉及到多个处理单元
- 较难测试

## 微核架构

微核架构（microkernel architecture）又称为“插件架构”（plug-in architecture），指软件的内核相对较小，主要功能和业务逻辑都通过插件实现。它的典型应用就是文本编辑器。

微核架构的内核（core）通常只包含系统运行的最小功能。插件则是互相独立的，插件之间的通信，应该减少到最低，避免出现依赖。

它的主要优点是

- 良好的延伸性（extensibility）
- 各个功能之间的隔离性
- 可定制性高
- 适合渐进式的开发，逐步增加功能

缺点

- 扩展性（Scalability）差，内核通常是一个独立单元，不容易做成分布式
- 开发难度相对较高，因为涉及到插件与内核的通信，以及内部的插件登记机制

## 微服务架构

微服务架构（microservices architecture）是服务导向架构（service-oriented architecture，缩写 SOA）的演变。服务指的是一个单一功能组件（component），它可以是一个简单的函数，也可以是多个模块（module）组成的大型应用。

最重要的是，每一个服务是一个独立部署单元（separately
deployed unit）。而是，这些单元都是分布式的，互相解耦，通过远程通信协议联系（比如REST、SOAP等等）。

微服务架构可以分成三种实现模式。

- RESTful API 模式：提供API的网站作为服务提供方，现在很流行的云服务就属于这一类。
- RESTful 应用软件模式：客户端请求不通过API层接收，而通过传统的网络协议或者应用协议接收。这一类的服务的背后，通常是一个多功能的应用程序，而不是单一功能的服务接口，常见于企业内部。
- 中央通信模式：不用REST模式通信，而采用中央消息代理（message broker）。相比REST模式，它的优点是可以实现消息队列、负载均衡、统一的消息日志和异常处理，扩展性更好。缺点是为了防止单点失败，Broker可能需要做成集群。

优点：

- 扩展性好，组件之间的低耦合
- 容易部署，软件从一个可部署单元，被拆成了多个可部署单元
- 容易开发，每个组件都可以进行持续集成式的开发，可以做到实时部署，不间断地升级
- 易于测试

缺点：

- 由于强调彼此独立和低耦合，服务可能必须拆分得很细。但是，如果一个系统依赖大量的微服务，整个系统就会变得很凌乱和笨重，性能也会不佳。
- 一旦服务之间需要通信（即一个服务要用到另一个服务），整个架构就会变得复杂。典型的例子就是一些小的Utility类，一种解决方案是把它们拷贝到每一个服务中去，用冗余换取架构的简单性。
- 由于分布式的本质，这种架构很难实现原子性操作，交易回滚会比较困难。

## 云架构

基于空间的架构（space-based architecture）解决扩展性和并发的问题。cloud
architecture pattern 最小化不利于扩展的因素 

 高扩展性（high scalability）依靠不是用中央数据库，而使用可复制的内存数据单元代替。 应用程序数据保存在内存中，被所有激活的处理单元（pr
cessing unit）共享。处理单元可以虽然访问量的增减，而打开和关闭。由于没有中央数据库，因此限制扩展性最大的瓶颈消失了。每个处理单元的数据都在内存里，最好要进行数据持久化。

这种架构主要适用于网站。这个模式主要分成两部分：处理单元（processing unit）和虚拟中间件（virtualized middleware）。处理单元包含业务逻辑，虚拟中间件主要用来处理通信、保持sessions、数据复制、分布式处理、处理单元的部署。

虚拟中间件包括以下组件：

- 消息中间件（Messaging Grid）：管理用户请求和session，当一个请求进来以后，决定分配给哪一个处理单元。
- 数据中间件（Data Grid）：将数据复制到每一个处理单元，即数据同步。保证某个处理单元都得到同样的数据。
- 处理中间件（Processing Grid）：可选，如果一个请求涉及不同类型的处理单元，该中间件负责协调处理单元
- 部署中间件（Deployment Manager）：负责处理单元的启动和关闭。它负责监控负载和响应时间，当负载增加，就新启动处理单元，负载减少，就关闭处理单元。

优点

- 高负载
- 动态部署

缺点

- 实现复杂，成本较高
- 主要适合网站类应用，不合适大量数据吞吐的大型数据库应用
- 较难测试