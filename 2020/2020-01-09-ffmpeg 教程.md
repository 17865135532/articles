# ffmpeg 命令

-   免费的开源软件，用于多媒体编辑，转换...
-   始于2000年

安装：

- [https://www.ffmpeg.org/download.html](https://www.ffmpeg.org/download.html)

最好用的是命令行。

## 概念

容器：容器包含媒体数据。典型示例：

MP4：H.264，H.264，AAC音频，…的MPEG-4 Part 14容器
MKV：适用于任何媒体格式的多功能容器
WebM：MKV的子集，Web流中的用法
AVI：旧版容器

查看支持的容器。

```bash
$ ffmpeg -formats
```

CODEC：支持的编码格式。

查看支持的编码格式，包括视频和音频。

```bash
$ ffmpeg -codecs
```

常用的编码格式

Currently mostly used, standardized by ITU/ISO:

- 🎥 H.262 / MPEG-2 Part H: Broadcasting, TV, used for backwards compatibility
- 🎥 H.264 / MPEG-4 Part 10: The de-facto standard for video encoding today
- 🎥 H.265 / HEVC / MPEG-H: Successor of H.264, up to 50% better quality
- 🔊 MP3 / MPEG-2 Audio Layer III: Used to be the de-facto audio coding standard
- 🔊 AAC / ISO/IEC 14496-3:2009: Advanced Audio Coding standard

Competitors that are royalty-free:

- 🎥 VP8: Free, open-source codec from Google (not so much in use anymore)
- 🎥 VP9: Successor to VP8, almost as good as H.265
- 🎥 AV1: A successor to VP9, claims to be better than H.265

上面这样都是有损的编码格式。无损的格式，体积较大，这里就不介绍了。

### ENCODERS

编码器：实际编码的库。

- 🎥 libx264: most popular free and open-source H.264 encoder
- 🎥 NVENC: NVIDIA GPU-based H.264 encoder
- 🎥 libx265: free and open-source HEVC encoder
- 🎥 libvpx: VP8 and VP9 encoder from Google
- 🎥 libaom: AV1 encoder
- 🔊 libfdk-aac: AAC encoder
- 🔊 aac: native FFmpeg AAC encoder

查看支持的编码器

```bash
$ ffmpeg -encoders
```

## 格式

ffmpeg {1} {2} -i {3} {4} {5}, where:

1. global options
2. input file options
3. input url
4. output file options
5. output url

**The parts 2, 3, 4 and 5 can be as many as you need. It's easier to understand this argument format in action:

```bash
$ ffmpeg \
<global-options> \
<input-options> \
-i <input> \
<output-options> \
<output>
```

```bash
# WARNING: this file is around 300MB
$ wget -O bunny_1080p_60fps.mp4 http://distribution.bbb3d.renderfarming.net/video/mp4/bbb_sunflower_1080p_60fps_normal.mp4

$ ffmpeg \
-y \ # global options
-c:a libfdk_aac -c:v libx264 \ # input options
-i bunny_1080p_60fps.mp4 \ # input url
-c:v libvpx-vp9 -c:a libvorbis \ # output options
bunny_1080p_60fps_vp9.webm # output url**
```

This command takes an input file mp4 containing two streams (an audio encoded with aac CODEC and a video encoded using h264 CODEC) and convert it to webm, changing its audio and video CODECs too.

FFmpeg will adopt or guess the default values for you. For instance when you just type ffmpeg -i input.avi output.mp4 what audio/video CODEC does it use to produce the output.mp4?

```bash
$ ffmpeg -i input.avi output.mp4
```

webm、mp4 都是容器格式。

## 用法

```bash
$ ffmpeg -i input.mp4 output.avi
```

### Transcoding

转换编码格式  (e.g. H.264 using libx264)

ffmpeg -i <input> -c:v libx264 output.mp4

视频格式（transcoding）：H264(AVC) 转 H265(HEVC)

```bash
$ ffmpeg \
-i bunny_1080p_60fps.mp4 \
-c:v libx265 \
bunny_1080p_60fps_h265.mp4
```

- `-c` sets the encoder (see ffmpeg -encoders)
- `-c copy` only copies bitstream
- `-c:v` sets only video encoders
- `-c:a` sets only audio encoders
- `-an` and `-vn` would disable audio or video streams
- `-preset`：输出的视频质量，有以下几个值 ultrafast, superfast, veryfast, faster, fast, medium, slow, slower, veryslow。

### Transmuxing

从一种容器转到另一种容器。

容器格式（transmuxing）：mp4 转 webm

下面是不转换编码的写法。

```
$ ffmpeg -i input.mp4 -c copy output.mkv
```

转换编码。

```bash
$ ffmpeg \
-i bunny_1080p_60fps.mp4 \
-c copy \ # just saying to ffmpeg to skip encoding
bunny_1080p_60fps.webm
```

视频的码率（transrating）：producing a rendition with bit rate between 3856K and 2000K.

```
$ ffmpeg \
-i bunny_1080p_60fps.mp4 \
-minrate 964K -maxrate 3856K -bufsize 2000K \
bunny_1080p_60fps_transrating_964_3856.mp4
```

改变视频分辨率（transsizing）：converting a 1080p to a 480p resolution.

```bash
$ ffmpeg \
-i bunny_1080p_60fps.mp4 \
-vf scale=480:-1 \
bunny_1080p_60fps_transsizing_480.mp4
```

从视频里面提取音频（demuxing）：Extracting  `audio`  from  `container`:

```bash
$ ffmpeg \
-i small_bunny_1080p_30fps.mp4 \
-vn -c:a copy \
small_bunny_audio.aac
```

音频加入视频（Muxing）

```bash
$ ffmpeg \
-i small_bunny_audio.aac -i small_bunny_1080p_30fps.mp4 \ small_bunny_1080p_30fps_muxed.mp4
```

### 截图

截图：Get images from 1s video:

```bash
$ ffmpeg \
-y \
-i /files/v/bunny_1080p_30fps.mp4 \
-ss 00:01:24 -t 00:00:01 \
smallest_bunny_1080p_30fps_%3d.jpg

$ ffmpeg \
-ss 01:23:45 \
-i input \
-vframes 1 -q:v 2 \
output.jpg
```

上面代码中，`-vframes 1`指定只截取一帧，`-q:v 2`表示输出的图片质量，`2`表示较高的质量。

### 裁剪（SEEKING AND CUTTING）

Cut a video from timestamp <start> for <duration>, or until <end>:

```bash
ffmpeg -ss <start> -i <input> -t <duration> -c copy <output>
ffmpeg -ss <start> -i <input> -to <end> -c copy <output>
```

Examples:

```bash
ffmpeg -ss 00:01:50 -i <input> -t 10.5 -c copy <output>
ffmpeg -ss 2.5 -i <input> -to 10 -c copy <output>
```

## 参考链接

- [FFmpeg libav tutorial](https://github.com/leandromoreira/ffmpeg-libav-tutorial#chapter-3---transcoding)
- [Digital video introduction](https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#split-and-merge-smoothly)
- [FFmpeg encoding and editing course](http://slhck.info/ffmpeg-encoding-course/)
- 
