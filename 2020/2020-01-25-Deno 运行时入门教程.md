# Deno 运行时入门教程：Node.js 的替代品

Deno 是 Node.js 的替代品。有了它，将来可能就不需要 Node.js 了。

- 为什么 Node.js 不能满足需要？
- Deno 能够带给我们什么？

以下内容主要基于 [Bert Belder](https://www.youtube.com/watch?v=puXyo1jGQys) 和 [Ryan Dahl](https://www.youtube.com/watch?v=1gIiZfSbEAE) 的最新演讲。

0、

![](https://www.wangbase.com/blogimg/asset/202001/bg2020012502.jpg)

进入主题之前，先说一下 Deno 这个词怎么发音。

两种发音，“德诺”和“蒂诺”，我都听到过。看起来，“蒂诺”这个发音应该更合适一些，因为 Deno 的标志是一只恐龙。恐龙（dinosaur）的英文缩写正是 dino。

1、

![](https://www.wangbase.com/blogimg/asset/202001/bg2020012503.jpg)

Deno 是 Ryan Dahl 在2017年创立的。

Ryan Dahl 也是 Node.js 的创始人，从2007年开始写，到2012年把这个项目交给了其他开发者，不再过时了。从那以后，他转向了人工智能，可是始终不是很喜欢 Python 语言。他就有了一个想法，想搞一个 JavaScript 语言的人工智能开发框架。

于是，他再回过头捡起 Node.js，发现 Node.js 已经背离了他的初衷，有一些无法忽视的问题。

1、

![](https://www.wangbase.com/blogimg/asset/202001/bg2020012505.jpg)

首先，过去五六年，JavaScript 语言脱胎换骨，ES6 标准引入了大量新的语法特性。其中，影响最大的语法有两个：Promise 接口（以及 async 函数）和 ES 模块。

Node.js 对这两个新语法的支持，都不理想。由于历史原因，Node.js 必须支持回调函数（callback），导致同一个接口会有 Promise 和回调函数两种写法；同时，Node.js 自己的模块格式 CommonJS 与 ES 模块不兼容，导致迟迟无法完全支持 ES 模块。

其次，Node.js 的模块管理工具 npm，逻辑越来越复杂；模块安装目录 npm_modules 极其庞杂，难以管理。npm 也几乎没有安全措施，用户只要下载了外部模块，就只好听任别人的代码在本地运行，进行各种读写操作。

再次，Node.js 的功能也不完整，导致外部工具层出不穷，让开发者疲劳不堪：webpack，babel，typescript、eslint、prettier……

1、

![](https://www.wangbase.com/blogimg/asset/202001/bg2020012504.jpg)

由于上面这些原因，Ryan Dahl 决定从头写一个 Node.js 的替代品，彻底解决这些问题。deno 这个名字就是来自 Node 的字母重新组合（Node = no + de），也表示“摧毁 Node.js”（de = destroy, no = Node.js）。

跟 Node.js 一样，Deno 也是一个服务器运行时，但是支持多种语言，可以直接运行 JavaScript、TypeScript 和 WebAssembly 程序。

它内置了 V8 引擎，用来解释 JavaScript；同时也内置了 tsc 引擎，所以可以解释 TypeScript；它自身使用 Rust 语言开发，由于 Rust 原生支持 WebAssembly，所以它也能直接运行 WebAssembly；它的异步操作不使用 libuv 这个库，而是使用 Rust 语言的 [Tokio](https://github.com/tokio-rs/tokio) 库，来实现事件循环（event loop）。

1、

![](https://www.wangbase.com/blogimg/asset/202001/bg2020012508.jpg)

你可能会问，为什么使用 Rust，而不是 C++（Node.js 的开发语言）？

主要原因是 Rust 提供了很多现成的模块，不用自己开发了。

1、

![](https://www.wangbase.com/blogimg/asset/202001/bg2020012509.jpg)

Deno 本身也是 Rust 的一个模块。如果你想在 Rust 里面使用 V8 引擎，就可以加载 Deno，它会提供一些底层 API，让你跟 V8 引擎互动。

1、

![](https://www.wangbase.com/blogimg/asset/202001/bg2020012511.jpg)

Deno 只有一个可执行文件，所有操作都通过这个可执行文件完成。

各种平台（Mac、Linux、Windows）都有各自的版本。

1、

![](https://www.wangbase.com/blogimg/asset/202001/bg2020012512.jpg)

Deno 具有安全控制，默认情况下脚本不具有读写权限。如果脚本读写文件系统或网络，会报错。

必须使用参数，显式打开权限才可以。

> - `--allow-read`：打开读权限，可以指定可读的目录，比如`--allow-read=/temp`。
> - `--allow-write`：打开写权限。
> - `--allow-net=google.com`：允许网络通信，可以指定可请求的域，比如`--allow-net=google.com`。
> - `--allow-env`：允许读取环境变量。

1、

![](https://www.wangbase.com/blogimg/asset/202001/bg2020012513.jpg)

Deno 支持 Web API，尽量跟浏览器保持一致，具有 window 这个全局对象，直接支持 fetch、webCrypto、worker、location 等 Web 标准，也支持 onload、onunload、addEventListener、dispatchEvent、removeEventListener 等事件操作函数。

此外，Deno 所有的异步操作，一律返回 Promise。

1、

![](https://www.wangbase.com/blogimg/asset/202001/bg2020012514.jpg)

Deno 只支持 ES 模块，跟浏览器的模块加载规则一致。没有 npm，没有 npm_modules 目录，没有`require()`命令（即不支持 CommonJS 模块），也不需要`package.json`文件。

所有模块通过 URL 加载（绝对 URL 或相对 URL），比如`import {bar} from "https://foo.com/bar.ts"`。因此，Deno 不需要一个中心化的模块储存系统，模块可以从任何网址加载。

Deno 下载模块以后，会在本地缓存，因此可以离线使用。

1、

![](https://www.wangbase.com/blogimg/asset/202001/bg2020012516.jpg)

由于 Deno 只支持从 URL 加载模块，导致下面这样的 Node.js 模块加载写法都会失效。

```javascript
import React from "react";
import { Box, Grid } from "@material-ui/core";
import { initializeApp } from "firebase/app";
```

1、

![](https://www.wangbase.com/blogimg/asset/202001/bg2020012515.jpg)

Deno 原生支持 TypeScript 语言，不需要 tsc 转码。

它的内部会根据文件后缀名判断，如果是`.ts`后缀名，就先调用 TS 编译器，否则就是 JavaScript 代码，直接传入 V8 引擎。

1、

![](https://www.wangbase.com/blogimg/asset/202001/bg2020012517.jpg)

Deno 内置了开发者需要的各种功能，不再需要安装外部工具，比如打包、格式清理、测试、安装、文档生成、linting、脚本编译成可执行文件等。

执行`deno -h`或`deno help`，就可以显示 Deno 支持的子命令。

> - `deno bundle`：将脚本和依赖打包
> - `deno eval`：执行代码
> - `deno fetch`：将依赖抓取到本地
> - `deno fmt`：代码的格式美化
> - `deno help`：等同于`-h`参数
> - `deno info`：显示本地的依赖缓存
> - `deno install`：将脚本安装为可执行文件
> - `deno repl`：进入 REPL 环境
> - `deno run`：运行脚本
> - `deno test`：运行测试

1、

![](https://www.wangbase.com/blogimg/asset/202001/bg2020012507.jpg)

Deno 的安装可以参考[官网首页](https://deno.land/)，但是更方便的方法是去 GitHub 仓库的[发布页](https://github.com/denoland/deno/releases)，直接下载编译好的可执行文件（上图）。

下载 Deno 以后，可以查看一下版本。

```bash
$ deno --version
deno 0.31.0
v8 8.1.108
typescript 3.7.2
```

命令行直接运行`deno`，就会进入 REPL 环境。

```bash
$ deno
> console.log(1,2,3)
1 2 3
undefined
> 
```

你也可以让 Deno 执行 TypeScript 脚本。

```bash
$ deno https://deno.land/std/examples/welcome.ts
```

1、

![](https://www.wangbase.com/blogimg/asset/202001/bg2020012518.jpg)

下面，运行一个官网给出的[例子](https://deno.land/std/examples/curl.ts)，大家感受一下 Deno。

```bash
$ deno run \
https://deno.land/std/examples/curl.ts \
https://example.com
```

上面例子中，Deno 下载远程脚本`curl.ts`，抓取网址`example.com`。运行后报错，表示没有权限。

我们给予 Deno 网络通信的权限，就可以顺利执行。

```bash
$ deno run --allow-net \
https://deno.land/std/examples/curl.ts \
https://example.com
```

1、

![](https://www.wangbase.com/blogimg/asset/202001/bg2020012510.jpg)

写作本文时，Deno 最新版本是 0.31。根据规划，1.0 应该很快就会发布。

它还处在密集开发中，功能还不稳定，不建议用于生产环境。但是，它是一个已经可用的工具，大家可以多试用，逐步熟悉它的用法。我相信，它在设计上的诸多优点，将会使它比 Node.js 更具优势。

（完）
