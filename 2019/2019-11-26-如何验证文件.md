# 如何识别文件的真假

每个人都下载文件，大家有没有想过，文件可能是假的，尤其来自网盘或专门的下载站。

本文就来谈谈如何识别文件的真假。

## 一、XcodeCodeGhost 事件

我们从一件真实的事件谈起。

2015年9月，[有人发现](https://web.archive.org/web/20150920191633/http://drops.wooyun.org/news/8864)某些 iOS App 会向可疑的网站发送数据。进一步调查发现，恶意代码是 Xcode 打包时植入的。也就是说，开发工具 Xcode 不是原始版本，被人修改过了。这称为 [XcodeGhost 事件](https://zh.wikipedia.org/wiki/XcodeGhost%E9%A3%8E%E6%B3%A2)。

[腾讯的安全团队](https://security.tencent.com/index.php/blog/msg/96)公告称，应用商店的前 5000 名应用有76个被感染，鉴于事件的严重性立刻向苹果官方报告了该事件。[360 应用商店](https://www.anquanke.com/post/id/82436)自查后发现，共有1076个应用被感染，包括微信、网易云音乐、滴滴打车、高德地图、12306、同花顺等热门应用。苹果公司将所有被感染的版本，都从官方软件商店下架了。

国家互联网应急中心发出了预警通知。

追查下去，那些修改过的 Xcode 都不是从官方渠道下载的，而是来自网盘或下载站。投毒者网名为“coderfun”，他在各种 iOS 开发者论坛或者微博留言，引诱其他开发者下载有毒版本的 Xcode，下毒的版本从 Xcode 6.1 到 6.4。

事后，这位 coderfun 发出匿名的致歉公告，表示这只是自己的实验行为，没有恶意。但是，这个事件足以引起警惕，下载的任何文件都不一定安全，很可能修改过或植入恶意代码。

## 二、软件的防伪措施

为了防止软件被修改后传播，很多平台都带有签名机制。软件发布时必须用平台的密钥签名，只有认证的开发商才能拿到密钥。

如果用户安装未签名的软件，平台会弹出警告，阻止安装。下面就是 MacOS 的提示框。

但是，不可能所有开发者都认证，尤其是认证要收费。而且，用户对这种警告不在乎，一般都会忽略或手动关闭检查机制。

所以，目前的常用做法是，软件开发者在发布软件时，同时给出哈希码和签名文件。前者是保证软件没有被第三方修改，后者是保证软件确实出自原始作者。

举例来说，Linux 的发行版 Manjaro 除了提供原始的 iso 文件，还提供另外三个文件：sha1 哈希文件、sha 256 文件和 sig 签名文件。 

## 三、哈希码校验

哈希码指的是，文件内容经过哈希函数的计算，会返回一个独一无二的字符串。哪怕原始内容只改动一个字节，哈希码也会完全不同。

所以，用户下载软件后，只要计算一下哈希码，再跟作者给出的哈希码比较一下，就会知道软件有没有改动。

目前，常用的是三种哈希函数（即三种哈希码）：MD5、SHA1 和 SHA256。其中，SHA256 最安全，SHA1 次之，MD5 垫底。一般来说，软件至少会提供其中一种哈希码。

Linux 系统很简单，直接用`md5sum`、`sha1sum`、`sha256sum`这三个命令就可以得到哈希码。

```bash
$ md5sum [filename]
$ sha1sum [filename]
$ sha256sum [filename]
```

上面命令显示哈希码以后，需要自己跟作者给出的哈希码比对。如果不一致，文件就是被改动了，或者没有完整下载。

有时，哈希码不是写在网页上，而是作为一个单独的文本文件下载，就像上一节的 Manjaro 例子。这时可以使用`-c`参数。

```bash
$ md5sum -c [HashFile]
$ sha1sum -c [HashFile]
$ sha256sum -c [HashFile]
```

上面命令会直接给出检查结果，如果文件跟哈希码一致，就显示“成功”。

MacOS 没有直接提供校验命令，需要下载安装。

```bash
$ brew install md5sha1sum
```

执行上面命令以后，`md5sum` 和 `sha1sum` 就可以使用了。至于 `sha256sum` 要用 `shasum -a256` 代替。

Windows 可以安装 [Quick hash](https://www.quickhash-gui.org/) 或者 [Raymond’s MD5 & SHA Checksum Utility](https://download.cnet.com/MD5-SHA-Checksum-Utility/3000-2092_4-10911445.html)。前者还支持 Linux 和 MacOS。

## 四、签名校验

哈希码只能保证文件内容没有修改，但是怎么保证哈希码是可靠的呢？比如，其他人完全可以冒充原始作者，推出一个新版本，一起给出哈希码。文件签名就能解决这个问题。

软件官网一般都会给出官方的公钥，比如 Manjaro 就可以从它的 GitHub 仓库下载公钥。

```bash
$ wget github.com/manjaro/packages-core/raw/master/manjaro-keyring/manjaro.gpg
```

签名一般使用 GPG 软件，所以公钥也是 GPG 格式，通常都会放在 GPG 的公钥服务器上面。所以，如果不信任  GitHub，也可以去公钥服务器导入公钥。`gpg`命令在 Linux 下可以直接使用，MacOS 和 Windows 需要安装 [GnuPG](https://gnupg.org/download/index.html)。

```bash
$ gpg --keyserver hkp://eu.pool.sks-keyservers.net --search-keys [公钥 ID]
```

上面命令会列出搜索结果，让你选择是否下载某一个公钥。`--keyserver`参数指定公钥服务器，`search-keys`参数给出搜索参数，可以是作者的名称，也可以是公钥的签名。

拿到公钥后，将其导入系统。

```bash
$ gpg --import [公钥文件]
```

如果有完整的公钥签名，`gpg` 命令的 `--recv-key`参数可以直接从服务器导入公钥。

```bash
$ gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-key "27DE B156 44C6 B3CF 3BD7  D291 300F 846B A25B AE09"
```

导入公钥以后，就可以验证签名文件（后缀名为 `sig`的 文件）。

```bash
# 用法一
$ gpg --verify [签名文件]

# 用法二
$ gpg --verify [签名文件] [原始文件]
```

上面命令的用法一，要求原始文件与签名文件同名，且在一个目录下。比如，签名文件是`foo.iso.sig`，原始文件必须是`foo.iso`。

签名文件一般包括完整签名指纹，所以也可以跳过上面的步骤，直接从公钥服务器获取公钥验证签名。

```bash
$ gpg --keyserver-options auto-key-retrieve --verify [签名文件]
```

（完）

